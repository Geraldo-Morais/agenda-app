<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metas de Hoje</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 10px; background-color: #f5f5f5; }
        #widget-container { display: flex; flex-direction: column; }
        .titulo-widget { font-size: 1.2em; font-weight: 700; margin-bottom: 8px; color: #333; }
        .lista-atividades-widget { list-style: none; margin: 0; padding: 0; }
        .atividade-widget { display: flex; align-items: center; margin-bottom: 5px; padding: 8px; border-radius: 4px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .atividade-widget.concluida { opacity: 0.6; text-decoration: line-through; }
        .descricao-widget { flex-grow: 1; }
        .horario-widget { font-size: 0.9em; margin-left: 8px; color: #777; }
        .sem-atividades { text-align: center; padding: 20px; color: #888; }
    </style>
</head>
<body>
    <div id="widget-container">
        <h2 class="titulo-widget">Metas de Hoje</h2>
        <ul id="lista-atividades-widget" class="lista-atividades-widget">
            <li class="sem-atividades">Carregando...</li>
        </ul>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyAYhpZykVwZ-_KVkgx5iGBAITKtcuZMfUQ",
                authDomain: "agenda-da-bea.firebaseapp.com",
                projectId: "agenda-da-bea",
                storageBucket: "agenda-da-bea.appspot.com",
                messagingSenderId: "509913679664",
                appId: "1:509913679664:web:9e251227071260b55e2af5"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            const listaAtividadesEl = document.getElementById('lista-atividades-widget');
            const mapaDosDias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

            const getWeekId = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return `${d.getUTCFullYear()}-${String(weekNo).padStart(2, '0')}`;
            };

            const loadTodayTasks = (user) => {
                const hoje = new Date();
                const nomeDiaHoje = mapaDosDias[hoje.getDay()];
                const semanaId = getWeekId(hoje);
                const semanaDocRef = db.collection('usuarios').doc(user.uid).collection('semanas').doc(semanaId);

                semanaDocRef.onSnapshot(doc => {
                    listaAtividadesEl.innerHTML = '';
                    if (doc.exists) {
                        const atividadesDoDia = doc.data()[nomeDiaHoje] || [];
                        if (atividadesDoDia.length > 0) {
                            atividadesDoDia.forEach(atv => {
                                const item = document.createElement('li');
                                item.className = 'atividade-widget';
                                if (atv.concluida) item.classList.add('concluida');
                                item.innerHTML = `<span class="descricao-widget">${atv.descricao}</span><span class="horario-widget">${atv.inicio || ''}</span>`;
                                listaAtividadesEl.appendChild(item);
                            });
                        } else {
                            listaAtividadesEl.innerHTML = '<li class="sem-atividades">Nenhuma atividade para hoje.</li>';
                        }
                    } else {
                        listaAtividadesEl.innerHTML = '<li class="sem-atividades">Abra o app principal para iniciar a semana.</li>';
                    }
                }, (error) => {
                    listaAtividadesEl.innerHTML = '<li class="sem-atividades">Erro ao carregar.</li>';
                });
            };

            auth.onAuthStateChanged((user) => {
                if (user) {
                    loadTodayTasks(user);
                } else {
                    auth.signInAnonymously().catch(() => {
                        listaAtividadesEl.innerHTML = '<li class="sem-atividades">Falha na autenticação.</li>';
                    });
                }
            });
        });
    </script>
</body>
</html>